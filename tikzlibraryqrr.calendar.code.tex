\usepgflibrary{qrr.calendar}

% Shift between days

\def\tikz@lib@cal@xshift{\pgfkeysvalueof{/tikz/day xshift}}
\def\tikz@lib@cal@yshift{\pgfkeysvalueof{/tikz/day yshift}}
\tikzset{day xshift/.initial=3ex,day yshift/.initial=3.5ex}

% Shift between months

\def\tikz@lib@cal@month@xshift{\pgfkeysvalueof{/tikz/month xshift}}
\def\tikz@lib@cal@month@yshift{\pgfkeysvalueof{/tikz/month yshift}}
\tikzset{month xshift/.initial=9ex,month yshift/.initial=9ex}

\tikzset{
  week code/.initial={%
    \node[every week]{\pgfkeysvalueof{/tikz/week text}};},
  week text/.initial={\%n=},
  every week/.style=%
}

%
% Overwriting original \tikz@lib@cal@if@else@code
%
\def\tikz@lib@cal@if@else@code#1#2#3{%
  \iftikz@lib@cal@exec@direct
    \expandafter\pgfutil@secondoftwo
  \else
    \expandafter\pgfutil@firstoftwo
  \fi
  {\expandafter\def\expandafter\tikz@lib@cal@ifs\expandafter{\tikz@lib@cal@ifs\ifdate{#1}{#2}{#3}}}%
  {\ifdate{#1}{#2}{#3}}%
  \tikz@lib@cal@scanner%
}

%
% Overwriting original \tikz@lib@cal@stop
%
\def\tikz@lib@cal@stop{%
    \pgftransformshift{\tikz@node@at}%
    \expandafter\pgfcalendar\expandafter{\tikz@fig@name}{\tikz@lib@cal@start}{\tikz@lib@cal@end}%
    {%
      \tikz@before@day%
      \scope%
        \tikz@atbegin@day%
        \tikz@lib@cal@exec@directtrue
        \tikz@lib@cal@ifs%
        \tikzdaycode%
        \tikz@atend@day%
      \endscope%
      \tikz@after@day%
    }%
  \endgroup%
}
\newif\iftikz@lib@cal@exec@direct