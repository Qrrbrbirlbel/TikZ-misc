% \pgfutil@usemodule{pgfcalendar}%
% \input{pgfcalendar.code.tex}%
\pgfqkeys{/pgf/calendar}{
    Jan/.code={\ifnum\pgfcalendarifdatemonth=1\pgfcalendarmatchestrue\fi},
    Feb/.code={\ifnum\pgfcalendarifdatemonth=2\pgfcalendarmatchestrue\fi},
    Mar/.code={\ifnum\pgfcalendarifdatemonth=3\pgfcalendarmatchestrue\fi},
    Apr/.code={\ifnum\pgfcalendarifdatemonth=4\pgfcalendarmatchestrue\fi},
    May/.code={\ifnum\pgfcalendarifdatemonth=5\pgfcalendarmatchestrue\fi},
    Jun/.code={\ifnum\pgfcalendarifdatemonth=6\pgfcalendarmatchestrue\fi},
    Jul/.code={\ifnum\pgfcalendarifdatemonth=7\pgfcalendarmatchestrue\fi},
    Aug/.code={\ifnum\pgfcalendarifdatemonth=8\pgfcalendarmatchestrue\fi},
    Sep/.code={\ifnum\pgfcalendarifdatemonth=9\pgfcalendarmatchestrue\fi},
    Oct/.code={\ifnum\pgfcalendarifdatemonth=10\pgfcalendarmatchestrue\fi},
    Nov/.code={\ifnum\pgfcalendarifdatemonth=11\pgfcalendarmatchestrue\fi},
    Dec/.code={\ifnum\pgfcalendarifdatemonth=12\pgfcalendarmatchestrue\fi},
    leap year/.code={%
        \pgfutil@tempcnta=#1\relax
        \divide\pgfutil@tempcnta4
        \multiply\pgfutil@tempcnta4
        \ifnum\pgfutil@tempcnta=#1\relax
            \divide\pgfutil@tempcnta100
            \multiply\pgfutil@tempcnta100
            \ifnum\pgfutil@tempcnta=#1\relax
                \divide\pgfutil@tempcnta400
                \multiply\pgfutil@tempcnta400
                \ifnum\pgfutil@tempcnta=#1\relax
                    \pgfcalendarmatchestrue
                \fi
            \else
                \pgfcalendarmatchestrue
            \fi
        \fi},
    leap year/.default=\pgfcalendarifdateyear,
    between days/.code args={#1and#2}{%
        \pgfutil@tempcnta=#1\relax
        \ifnum\pgfcalendarifdateday<\pgfutil@tempcnta\else
            \pgfutil@tempcnta=#2\relax
            \ifnum\pgfcalendarifdateday>\pgfutil@tempcnta\else
                \pgfcalendarmatchestrue\fi\fi},
    % setup nths weekdays/.style args={#1 #2:#3}{%
    %     #1 #2/.code=%
    %          \begingroup
    %             \let\pgf@cal@tempa\pgfutil@empty
    %             \pgfcalendar@launch@ifdate{#2}{%
    %                 \pgfcalendar@launch@ifdate{between days=#3}{%
    %                     \def\pgf@cal@tempa{\let\ifpgfcalendarmatches\iftrue}%
    %                 }{%
    %                     \def\pgf@cal@tempa{\let\ifpgfcalendarmatches\iffalse}%
    %                 }%
    %             }{}%
    %         \expandafter\endgroup\pgf@cal@tempa
    % },
    % setup nths weekdays/.list={%
    %     first Monday:1and7,first Tuesday:1and7,first Wednesday:1and7,first Thursday:1and7,first Friday:1and7,first Saturday:1and7,first Sunday:1and7,%
    %     second Monday:8and14,second Tuesday:8and14,second Wednesday:8and14,second Thursday:8and14,second Friday:8and14,second Saturday:8and14,second Sunday:8and14,%
    %     third Monday:15and21,third Tuesday:15and21,third Wednesday:15and21,third Thursday:15and21,third Friday:15and21,third Saturday:15and21,third Sunday:15and21,%
    %     fourth Monday:22and28,fourth Tuesday:22and28,fourth Wednesday:22and28,fourth Thursday:22and28,fourth Friday:22and28,fourth Saturday:22and28,fourth Sunday:22and28,%
    %     fifth Monday:29and31,fifth Tuesday:29and31,fifth Wednesday:29and31,fifth Thursday:29and31,fifth Friday:29and31,fifth Saturday:29and31,fifth Sunday:29and31},
    week of month/.code={%
        \pgfutil@tempcnta=#1\relax
        \multiply\pgfutil@tempcnta7
        \ifnum\pgfcalendarifdateday>\pgfutil@tempcnta\else
            \advance\pgfutil@tempcnta-7
            \ifnum\pgfcalendarifdateday>\pgfutil@tempcnta
                \pgfcalendarmatchestrue
            \fi
        \fi},
    week of month'/.code={%
        \pgfcalendar@getlastYMX\pgfcalendarifdateyear\pgfcalendarifdatemonth\pgfutil@tempcnta
        \advance\pgfutil@tempcnta1
        \pgfutil@tempcntb=#1\relax
        \multiply\pgfutil@tempcntb7
        \advance\pgfutil@tempcnta-\pgfutil@tempcntb
        \ifnum\pgfcalendarifdateday<\pgfutil@tempcnta\else
            \advance\pgfutil@tempcnta+7
            \ifnum\pgfcalendarifdateday<\pgfutil@tempcnta
                \pgfcalendarmatchestrue
            \fi
        \fi},
    first/.code={\pgfutil@in@:{#1}\ifpgfutil@in@
        \pgfcalendar@ifdate@first{}#1\pgf@stop\else
        \pgfcalendar@ifdate@first{}1:#1\pgf@stop\fi},
    last/.code={\pgfutil@in@:{#1}\ifpgfutil@in@
        \pgfcalendar@ifdate@first'#1\pgf@stop\else
        \pgfcalendar@ifdate@first'1:#1\pgf@stop\fi},
    % logic
    and/.code 2 args=% and = {<cond 1>}{<cond 2>}
        \begingroup
            \let\pgf@cal@tempa\pgfutil@empty
            \pgfcalendar@launch@ifdate{#1}{%
                \pgfcalendar@launch@ifdate{#2}{%
                    \def\pgf@cal@tempa{\pgfcalendarmatchestrue}%
                }{}%
            }{}%
        \expandafter\endgroup\pgf@cal@tempa,
    And/.code=% <cond 1>, And = <cond 2>, And = <cond 3>, …
        \begingroup
            \let\pgf@cal@tempa\pgfutil@empty
            \ifpgfcalendarmatches
                \expandafter\pgfutil@firstofone
            \else
                \expandafter\pgfutil@gobble
            \fi
            {\pgfcalendar@launch@ifdate{#1}{\def\pgf@cal@tempa{\pgfcalendarmatchestrue}}{\def\pgf@cal@tempa{\pgfcalendarmatchesfalse}}}%
        \expandafter\endgroup\pgf@cal@tempa,
    not/.code=%
        \begingroup
            \let\pgf@cal@tempa\pgfutil@empty
            \pgfcalendar@launch@ifdate{#1}{}{\def\pgf@cal@tempa{\pgfcalendarmatchestrue}}%
        \expandafter\endgroup\pgf@cal@tempa,
    NOT/.style={not={#1}},
    AND/.code=% AND = {<cond 1>, <cond 2>, <cond 3>, …}
        \begingroup
            \pgfcalendarmatches@true
            \let\pgf@cal@tempa\pgfutil@empty
            \pgfcalendar@launch@ifdate{AND/.cd,#1}{%
            \ifPgfCalendarMatches@T{%
                \def\pgf@cal@tempa{\pgfcalendarmatchestrue}
            }}{}%
        \expandafter\endgroup\pgf@cal@tempa,
    AND/.unknown/.code=%
        \ifPgfCalendarMatches@T{%
            \expandafter\pgfcalendar@launch@ifdate\expandafter{\pgfkeyscurrentname={#1}}{}{\pgfcalendarmatches@false}%
        },
    OR/.code=\pgfqkeys{/pgf/calendar}{#1}%
}
\newif\ifpgfcalendarmatches@
% \def\ifPgfCalendarMatches@{\ifpgfcalendarmatches@\expandafter\pgfutil@firstoftwo\else\expandafter\pgfutil@secondoftwo\fi}
\def\ifPgfCalendarMatches@T{\ifpgfcalendarmatches@\expandafter\pgfutil@firstofone\else\expandafter\pgfutil@gobble\fi}
% \def\ifPgfCalendarMatches@F{\ifpgfcalendarmatches@\expandafter\pgfutil@gobble\else\expandafter\pgfutil@firstofone\fi}
% \def\pgfcalendarset{\pgfqkeys{/pgf/calendar}}
% TODO: active colon
\def\pgfcalendar@ifdate@first#1#2:#3\pgf@stop{%
    \pgfqkeys{/pgf/calendar}{and={#3}{week of month#1={#2}}}}
\def\pgfcalendar@getlastYMX#1#2#3{% #1 = year, #2 = month, #3 := last day
    \begingroup
        \ifnum#2=2 % stupid February
            \pgfqkeys{/pgf/calendar}{leap year=#1}
            \ifpgfcalendarmatches
                #3=29
            \else
                #3=28
            \fi
        \else
            #3=\ifcase\pgfcalendarifdatemonth\or
            31\or\or31\or30\or31\or30\or31\or31\or30\or31\or30\or31\fi\relax
        \fi\expandafter
    \endgroup
    \expandafter#3\the#3\relax}

%
% Weeknumbers
%
\def\pgfcalendar@weeknumber@setup#1{%
  \pgfutil@IfUndefined{pgfcalendar@weeknumber@#1}{%
    \begingroup
      \pgfcalendardatetojulian{#1-01-01}\pgfutil@tempcnta
      \pgfcalendarjuliantoweekday\pgfutil@tempcnta\pgfutil@tempcntb
      %
      % tempcnta holds the julian number for first day of the current year
      % tempcntb holds the weekday for the first day of the current year
      %
      % set tempcnta to the Monday of the week with first day of current year
      %
      \advance\pgfutil@tempcnta by -\pgfutil@tempcntb
      %
      % if the first week starts at Fri, Sat or Sun, next week is the 1st week
      %
      \ifnum\pgfutil@tempcntb>3\relax
        \advance\pgfutil@tempcnta by 7\relax
      \fi
      %
      \edef\pgf@cal@temp{\def\expandafter\noexpand\csname pgfcalendar@weeknumber@#1\endcsname
        {{\the\pgfutil@tempcnta}{\the\pgfutil@tempcntb}}}%
      \expandafter\endgroup\pgf@cal@temp
  }{}%
}

\def\pgfcalendarjulianyeartoweeknumber#1#2#3{\pgfcalendarjulianyeartoweeknumber@#1{#2}#3\iftrue}
\def\pgfcalendarjulianyeartoweeknumber@#1#2#3#4{%
  % #1 = julian date (count)
  % #2 = year
  % #3 = count that holds the week number at the end
  \begingroup
    \pgfcalendar@weeknumber@setup{#2}%
    #3=#1\relax
    %
    % calculate difference of days between current date and start of week number 1
    %
    \advance#3 by -\expandafter\expandafter\expandafter\pgfutil@firstoftwo\csname pgfcalendar@weeknumber@#2\endcsname\relax
    \ifnum#3<0\relax % whoops, we are in the week of the previous year
      \expandafter\pgfutil@firstoftwo
    \else
      \expandafter\pgfutil@secondoftwo
    \fi
    {% if first day of the year is Fri, Sat or Sun
      \ifnum\expandafter\expandafter\expandafter\pgfutil@secondoftwo\csname pgfcalendar@weeknumber@#2\endcsname>3\relax
        \expandafter\pgfutil@firstoftwo
      \else
        \expandafter\pgfutil@secondoftwo
      \fi
      {% we need to check the weeknumber of the previous
        #3=#2\relax
        \advance#3 by -1\relax
        \edef\pgf@cal@temp{\noexpand\pgfcalendarjulianyeartoweeknumber@#1{\the#3}#3\noexpand\iffalse}%
        \pgf@cal@temp
      }{% yeah, it's weird
        \divide#3 by 7\relax
        \advance#3 by 1\relax        
      }
    }{%
      \divide#3 by 7\relax
      \advance#3 by 1\relax
      #4%
        \expandafter\pgfutil@firstofone
      \else
        \expandafter\pgfutil@gobble
      \fi
      {%
        \ifnum#3=53\relax % whoops, we are possibly in the week of the next year
            \expandafter\pgfutil@firstofone
        \else
            \expandafter\pgfutil@gobble
        \fi
        {%
          \begingroup
            \pgfcalendarmatchesfalse
            \pgfkeys{/pgf/calendar/leap year=#2}%
            \ifpgfcalendarmatches
                \expandafter\pgfutil@firstoftwo
            \else
                \expandafter\pgfutil@secondoftwo
            \fi
            {% leap year
                \ifnum\expandafter\expandafter\expandafter\pgfutil@secondoftwo\csname pgfcalendar@weeknumber@#2\endcsname=3\relax
                \else % must be week 1 from the next year
                \ifnum\expandafter\expandafter\expandafter\pgfutil@secondoftwo\csname pgfcalendar@weeknumber@#2\endcsname=2\relax\else
                    #3=1\relax
                \fi
                \fi
            }{% not a leap year, only week 53 possible when it starts and ends on a Thursday
                \ifnum\expandafter\expandafter\expandafter\pgfutil@secondoftwo\csname pgfcalendar@weeknumber@#2\endcsname=3\relax
                \else % must be week 1 from the next year
                #3=1\relax
                \fi
            }
            \expandafter
          \endgroup\expandafter#3\the#3\relax
        }
      }%
    }%
    \expandafter
  \endgroup\expandafter
  #3\the#3\relax
}

%
% shorthands for weeknumbers (n)
%
% n-: shortest
% n=: shortest but prepends whitespace
% n0: leading zero
%
\expandafter\def\csname pgfcalendar@shorthand@n-\endcsname{%
  {\pgfutil@tempcnta=\pgfcalendarcurrentweeknumber\relax\the\pgfutil@tempcnta}}
\expandafter\def\csname pgfcalendar@shorthand@n=\endcsname{%
  {\pgfutil@tempcnta=\pgfcalendarcurrentweeknumber\relax\ifnum\pgfutil@tempcnta<10\relax\setbox0=\hbox{1}\kern\wd0\relax\fi\the\pgfutil@tempcnta}}
\expandafter\def\csname pgfcalendar@shorthand@n0\endcsname{%
  \pgfcalendarcurrentweeknumber}

%
% Overwriting original \pgfcalendar
%
\long\def\pgfcalendar#1#2#3#4{%
  \begingroup%
    % Setup local \ifdate
    \let\ifdate=\pgfcalendar@local@ifdate%
    % Let's start with computing start and end dates...
    \def\pgfcalendarprefix{#1}%
    \pgfcalendardatetojulian{#2}{\pgfcalendarcurrentjulian}%
    \edef\pgfcalendarbeginjulian{\the\pgfcalendarcurrentjulian}%
    \edef\pgfcalendarbeginiso{#2}%
    \pgfcalendardatetojulian{#3}{\pgfutil@tempcnta}%
    \edef\pgfcalendarendjulian{\the\pgfutil@tempcnta}%
    \advance\pgfutil@tempcnta by1\relax%
    \edef\pgfcalendarendjulianplus{\the\pgfutil@tempcnta}%
    \edef\pgfcalendarendiso{#3}%
    %
    % Start main loop
    %
    \loop%
    \ifnum\pgfcalendarcurrentjulian<\pgfcalendarendjulianplus\relax%
      % Setup information about current date
      \pgfcalendarjuliantodate{\pgfcalendarcurrentjulian}%
        {\pgfcalendarcurrentyear}{\pgfcalendarcurrentmonth}{\pgfcalendarcurrentday}%
      \pgfcalendarjuliantoweekday{\pgfcalendarcurrentjulian}{\pgfutil@tempcntb}%
      \edef\pgfcalendarcurrentweekday{\the\pgfutil@tempcntb}%
      \pgfcalendarjulianyeartoweeknumber{\pgfcalendarcurrentjulian}{\pgfcalendarcurrentyear}{\pgfutil@tempcntb}%
      \edef\pgfcalendarcurrentweeknumber{\ifnum\pgfutil@tempcntb<10 0\fi\the\pgfutil@tempcntb}%
      % Render:
      #4%
      % Advance day:
      \advance\pgfcalendarcurrentjulian by1\relax%
    \repeat%
  \endgroup%
}

%
% Overwriting original \pgfcalendar@local@ifdate
%
\def\pgfcalendar@local@ifdate{%
  \let\pgfcalendarifdatejulian=\pgfcalendarcurrentjulian
  \let\pgfcalendarifdateyear=\pgfcalendarcurrentyear
  \let\pgfcalendarifdatemonth=\pgfcalendarcurrentmonth
  \let\pgfcalendarifdateday=\pgfcalendarcurrentday
  \let\pgfcalendarifdateweekday=\pgfcalendarcurrentweekday
  \let\pgfcalendarifdateweeknumber=\pgfcalendarcurrentweeknumber
  \pgfcalendar@launch@ifdate%
}

\pgfqkeys{/pgf/calendar}{week number/.code=\ifnum#1=\pgfcalendarifdateweeknumber\relax\pgfcalendarmatchestrue\fi}