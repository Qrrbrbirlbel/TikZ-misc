\pgfutil@usemodule{pgfcalendar}%
\pgfqkeys{/pgf/calendar}{
    and/.code 2 args={%
        \pgfqkeys{/pgf/calendar}{#1}%
        \ifpgfcalendarmatches
            \pgfcalendarmatchesfalse
            \pgfqkeys{/pgf/calendar}{#2}%
        \fi},
    Jan/.code={\ifnum\pgfcalendarifdatemonth=1\relax\pgfcalendarmatchestrue\fi},
    Feb/.code={\ifnum\pgfcalendarifdatemonth=2\relax\pgfcalendarmatchestrue\fi},
    Mar/.code={\ifnum\pgfcalendarifdatemonth=3\relax\pgfcalendarmatchestrue\fi},
    Apr/.code={\ifnum\pgfcalendarifdatemonth=4\relax\pgfcalendarmatchestrue\fi},
    May/.code={\ifnum\pgfcalendarifdatemonth=5\relax\pgfcalendarmatchestrue\fi},
    Jun/.code={\ifnum\pgfcalendarifdatemonth=6\relax\pgfcalendarmatchestrue\fi},
    Jul/.code={\ifnum\pgfcalendarifdatemonth=7\relax\pgfcalendarmatchestrue\fi},
    Aug/.code={\ifnum\pgfcalendarifdatemonth=8\relax\pgfcalendarmatchestrue\fi},
    Sep/.code={\ifnum\pgfcalendarifdatemonth=9\relax\pgfcalendarmatchestrue\fi},
    Oct/.code={\ifnum\pgfcalendarifdatemonth=10\relax\pgfcalendarmatchestrue\fi},
    Nov/.code={\ifnum\pgfcalendarifdatemonth=11\relax\pgfcalendarmatchestrue\fi},
    Dez/.code={\ifnum\pgfcalendarifdatemonth=12\relax\pgfcalendarmatchestrue\fi},
    leap year/.code={%
        \pgfutil@tempcnta=#1\relax
        \divide\pgfutil@tempcnta4
        \multiply\pgfutil@tempcnta4
        \ifnum\pgfutil@tempcnta=#1\relax
            \divide\pgfutil@tempcnta100
            \multiply\pgfutil@tempcnta100
            \ifnum\pgfutil@tempcnta=#1\relax
                \divide\pgfutil@tempcnta400
                \multiply\pgfutil@tempcnta400
                \ifnum\pgfutil@tempcnta=#1\relax
                    \pgfcalendarmatchestrue
                \fi
            \else
                \pgfcalendarmatchestrue
            \fi
        \fi},
    leap year/.default=\pgfcalendarifdateyear,
    week of month/.code={%
        \pgfutil@tempcnta=#1\relax
        \multiply\pgfutil@tempcnta7\relax
        \ifnum\pgfcalendarifdateday>\pgfutil@tempcnta\else
            \advance\pgfutil@tempcnta-7\relax
            \ifnum\pgfcalendarifdateday>\pgfutil@tempcnta
                \pgfcalendarmatchestrue
            \fi
        \fi},
    week of month'/.code={%
        \pgfcalendar@getlastYMX\pgfcalendarifdateyear\pgfcalendarifdatemonth\pgfutil@tempcnta
        \advance\pgfutil@tempcnta1
        \pgfutil@tempcntb=#1\relax
        \multiply\pgfutil@tempcntb7\relax
        \advance\pgfutil@tempcnta-\pgfutil@tempcntb\relax
        \ifnum\pgfcalendarifdateday<\pgfutil@tempcnta\else
            \advance\pgfutil@tempcnta+7\relax
            \ifnum\pgfcalendarifdateday<\pgfutil@tempcnta
                \pgfcalendarmatchestrue
            \fi
        \fi},
    first/.code={\pgfutil@in@:{#1}\ifpgfutil@in@
        \pgfcalendar@ifdate@first{}#1\pgf@stop\else
        \pgfcalendar@ifdate@first{}1:#1\pgf@stop\fi},
    last/.code={\pgfutil@in@:{#1}\ifpgfutil@in@
        \pgfcalendar@ifdate@first'#1\pgf@stop\else
        \pgfcalendar@ifdate@first'1:#1\pgf@stop\fi}}
\def\pgfcalendar@ifdate@first#1#2:#3\pgf@stop{%
    \pgfqkeys{/pgf/calendar}{and={#3}{week of month#1={#2}}}}
\def\pgfcalendar@getlastYMX#1#2#3{% #1 = year, #2 = month, #3 := last day
    \begingroup
        \ifnum#2=2 % stupid February
            \pgfcalendar@launch@ifdate{leap year=#1}{#3=29\relax}{#3=28\relax}%
        \else
            #3=\ifcase\pgfcalendarifdatemonth\or
            31\or\or31\or30\or31\or30\or31\or31\or30\or31\or30\or31\fi\relax
        \fi\expandafter
    \endgroup
    \expandafter#3\the#3\relax}